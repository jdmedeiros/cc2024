#!/bin/bash

# Variables
VPC_NAME="angra-vpc"
VPC_CIDR="172.16.0.0/16"
REGION="us-west-2"
EXPECTED_AZS=1
EXPECTED_PUBLIC_SUBNETS=1
EXPECTED_PRIVATE_SUBNETS=2

# Fetch VPC ID
VPC_ID=$(aws ec2 describe-vpcs --region $REGION --filters "Name=tag:Name,Values=$VPC_NAME" --query "Vpcs[?CidrBlock=='$VPC_CIDR'].VpcId" --output text)

if [ -z "$VPC_ID" ]; then
    echo "VPC with name $VPC_NAME and CIDR $VPC_CIDR not found in region $REGION."
    exit 1
fi

echo "VPC $VPC_NAME found with ID $VPC_ID."

# Check Availability Zones
AZ_COUNT=$(aws ec2 describe-subnets --region $REGION --filters "Name=vpc-id,Values=$VPC_ID" --query "length(unique(Subnets[].AvailabilityZone))")

if [ "$AZ_COUNT" -eq "$EXPECTED_AZS" ]; then
    echo "Availability Zone count matches: $AZ_COUNT"
else
    echo "Expected $EXPECTED_AZS Availability Zones, but found $AZ_COUNT."
fi

# Check Public Subnets
PUBLIC_SUBNET_COUNT=$(aws ec2 describe-subnets --region $REGION --filters "Name=vpc-id,Values=$VPC_ID" "Name=map-public-ip-on-launch,Values=true" --query "length(Subnets)")

if [ "$PUBLIC_SUBNET_COUNT" -eq "$EXPECTED_PUBLIC_SUBNETS" ]; then
    echo "Public subnet count matches: $PUBLIC_SUBNET_COUNT"
else
    echo "Expected $EXPECTED_PUBLIC_SUBNETS public subnets, but found $PUBLIC_SUBNET_COUNT."
fi

# Check Private Subnets
PRIVATE_SUBNET_COUNT=$(aws ec2 describe-subnets --region $REGION --filters "Name=vpc-id,Values=$VPC_ID" "Name=map-public-ip-on-launch,Values=false" --query "length(Subnets)")

if [ "$PRIVATE_SUBNET_COUNT" -eq "$EXPECTED_PRIVATE_SUBNETS" ]; then
    echo "Private subnet count matches: $PRIVATE_SUBNET_COUNT"
else
    echo "Expected $EXPECTED_PRIVATE_SUBNETS private subnets, but found $PRIVATE_SUBNET_COUNT."
fi
